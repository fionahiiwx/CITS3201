-- Populate Countries table
INSERT INTO Countries (country_name, country_code, country_3_letter_code)
SELECT DISTINCT ON (country_name, country_3_letter_code)
    country_name,
    MAX(country_code) AS country_code,  -- get non-null value if available
    country_3_letter_code
FROM OlympicMedals
GROUP BY country_name, country_3_letter_code;
-- 154

INSERT INTO Countries (country_name, country_3_letter_code)
SELECT DISTINCT
    e.country_name,
    e.country_3_letter_code  
FROM Economic e
WHERE NOT EXISTS (
    SELECT 1
    FROM Countries c
    WHERE c.country_name = e.country_name
      OR c.country_3_letter_code = e.country_3_letter_code
);
-- 0

INSERT INTO Countries (country_name, country_3_letter_code)
SELECT DISTINCT
    m.entity,
    m.country_3_letter_code  
FROM MentalIllness m
WHERE NOT EXISTS (
    SELECT 1
    FROM Countries c
    WHERE c.country_name = m.entity
      OR c.country_3_letter_code = m.country_3_letter_code
);
-- 0

INSERT INTO Countries (country_name, country_3_letter_code)
SELECT DISTINCT
    l.entity,
    l.country_3_letter_code  
FROM LifeExpectancy l
WHERE NOT EXISTS (
    SELECT 1
    FROM Countries c
    WHERE c.country_name = l.entity
      OR c.country_3_letter_code = l.country_3_letter_code
);
-- 0

-- Create a temporary table with data ordered by country_name
DROP TABLE IF EXISTS Countries_temp;
CREATE TEMP TABLE Countries_temp AS
SELECT *
FROM Countries
ORDER BY country_name;

-- Recreate the original Countries table with a SERIAL country_id
DROP TABLE IF EXISTS countries;
CREATE TABLE countries (
    country_id SERIAL PRIMARY KEY,
    country_name TEXT UNIQUE NOT NULL,
    country_code VARCHAR(10),
    country_3_letter_code VARCHAR(10) UNIQUE
);

-- Insert data from the temporary table to maintain the order
INSERT INTO countries (country_name, country_code, country_3_letter_code)
SELECT country_name, country_code, country_3_letter_code
FROM Countries_temp;

DROP TABLE Countries_temp;
SELECT * FROM countries;

-- #####################################################################
-- Add economic_id to Economic table
ALTER TABLE Economic ADD COLUMN economic_id SERIAL PRIMARY KEY;
ALTER TABLE Economic ADD COLUMN country_id INT;
UPDATE Economic
SET country_id = c.country_id
FROM Countries c
WHERE Economic.country_code = c.country_3_letter_code;
SELECT * FROM Economic;